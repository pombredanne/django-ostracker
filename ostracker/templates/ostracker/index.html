{% extends "ostracker/base.html" %}
{% load charthelpers %}
{% load ostracker_tags %}

{% block title %}ostracker{% endblock %}

{% block content %}

<h2>Summary</h2>
<div id="languages" style="width: 400px; height:300px;"> </div>

<div id="timeline" style="width: 600px; height:300px;"> </div>

<div id="issues" style="width: 600px; height:300px;"> </div>

<div id="people" style="width: 600px; height:300px;"> </div>


<h2>All Projects</h2>

<table id="projects">
<thead>
<tr>
    <th>Name</th>
    <th>Created&nbsp;Date</th>
    <th>Latest&nbsp;Commit</th>
    <th>Open&nbsp;Issues</th>
    <th>Closed&nbsp;Issues</th>
    <th>Forks</th>
    <th>Watchers</th>
    <th>Collaborators</th>
    <th>Tags</th>
</tr>
</thead>
<tbody>
{% for proj in projects %}
<tr class="{% cycle 'even' 'odd' %}">
    <td><a href="{% url ostracker_project proj.name %}">{{proj.name}}</a></td>
    <td>{{proj.created_date}}</td>
    <td>{{proj.latest_commit}}</td>
    <td class="sparkline">
        {% render_proj_variable proj.open_issues %}
    </td>
    <td class="sparkline">
        {% render_proj_variable proj.closed_issues %}
    </td>
    <td class="sparkline">
        {% render_proj_variable proj.forks %}
    </td>
    <td class="sparkline">
        {% render_proj_variable proj.watchers %}
    </td>
    <td class="sparkline">
        {% render_proj_variable proj.collaborators %}
    </td>
    <td class="sparkline">
        {% render_proj_variable proj.tagged_releases %}
    </td>
</tr>
{% endfor %}
</tbody>
</table>
{% endblock content %}

{% block extrahead %}
{{ block.super }}

<style type="text/css">
    td.sparkline { min-width: 100px; }
    td.sparkline img { float: left; }
    td .delta { color: red; }
</style>

<script type="text/javascript">
    function textExtractor(node) {
        return node.innerHTML.split('<')[0]
    }
    $(document).ready(function() {
            $('#projects').tablesorter({'textExtraction': textExtractor});
    });
</script> 

<script>
$(document).ready(function() {

var languages = new Highcharts.Chart({
   chart: { renderTo: 'languages', defaultSeriesType: 'column' },
   title: { text: 'Projects by Language' },
   tooltip: {
       formatter: function() {
         return '<b>'+ this.x +'</b>: '+ this.y +' projects';
      }
  },
  xAxis: {
      categories: [{% for k in by_lang.keys %} '{{k}}' {% if not forloop.last %},{%endif%}{%endfor%}]
  },
  yAxis: { min: 0, title: { enabled: false } },
   plotOptions: {
      pie: {
         dataLabels: {
            enabled: true, color: 'white',
            formatter: function() {
                if (this.y > 5) {
                    return this.point.name;
                }
            },
         }
      }
   },
   legend: { enabled: false },
   credits: { enabled: false },
   series: [{
      name: 'language share',
      data: {{by_lang.values}}
   }]
});

var chart = new Highcharts.Chart({
   chart: { renderTo: 'timeline', zoomType: 'x' },
   title: { text: 'Projects' },
   xAxis: {
      title: { text: 'Month' },
      type: 'datetime',
      maxZoom: 60*24*3600000
   },
   yAxis: {
      title: { text: 'Projects' },
      min: 0
   },
   legend: { enabled: false },
   credits: { enabled: false },
   tooltip: {
      formatter: function() {
         return '<b>'+ (this.point.name || this.series.name) +'</b><br/>'+ Highcharts.dateFormat("%b '%y", this.x) + ': ' + this.y + ' projects';
      }
   },
   series: [{
       name: 'Projects',
       type: 'area',
       data: [
          {% for o in cumulative %}
          [{{o.0|jsdate}}, {{o.1}}]
          {% if not forloop.last %} , {% endif %}
          {% endfor %}
       ]
    }]
});


var chart = new Highcharts.Chart({
   chart: { renderTo: 'issues', defaultSeriesType: 'area' },
   title: { text: 'Issues' },
   credits: { enabled: false },
   xAxis: {
      categories: {{status_dates|safe}},
      tickmarkPlacement: 'on',
      title: {
         enabled: false
      }
   },
   yAxis: {
      title: { enabled: false },
      labels: {
         formatter: function() {
            return this.value;
         }
      }
   },
   tooltip: {
      formatter: function() {
         return '<b>'+ this.series.name +'</b><br/>'+
             this.x +': '+ Highcharts.numberFormat(this.y, 0, ',');
      }
   },
   credits: { enabled: false },
   plotOptions: {
      area: {
         stacking: 'normal',
         lineColor: '#666666',
         lineWidth: 1,
         marker: {
            lineWidth: 1,
            lineColor: '#666666'
         }
      }
   },
   series: [
       { name: 'open issues', data: {{open_issues}} },
       { name: 'closed issues', data: {{closed_issues}} }
   ]
});

var chart2 = new Highcharts.Chart({
   chart: { renderTo: 'people', defaultSeriesType: 'line', margin: [50, 150, 60, 80] },
   title: { text: 'People', style: { margin: '10px 100px 0 0' } },
   xAxis: { categories: {{status_dates|safe}}, title: { text: 'Month' } },
   yAxis: { plotLines: [{ value: 0, width: 1, color: '#808080' }], title: { enabled: false } },
   tooltip: {
      formatter: function() {
        return '<b>'+ this.series.name +'</b><br/>'+ this.x +': '+ this.y;
      }
   },
   legend: { layout: 'vertical', style: { left: 'auto', bottom: 'auto', right: '10px', top: '100px' } },
   credits: { enabled: false },
   series: [
       { name: 'forks', data: {{forks}} },
       { name: 'watchers', data: {{watchers}} },
       { name: 'collaborators', data: {{collaborators}} }
   ]
});

});

</script>

{% endblock extrahead %}
